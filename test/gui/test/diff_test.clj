(ns gui.test.diff_test
  (:use gui.diff
        clojure.test)
  (:require [gui.diff :as gd]
            [ordered.map :as om]
            [ordered.set :as os]))


(deftest test-all-public-var-have-doc-strings
  (is (empty? (->> (ns-publics 'gui.diff)
                   vals
                   (remove (comp :doc meta))))))

(deftype UnComparable [x]
  Object
  (equals [this that]
    (and (instance? UnComparable that)
         (= (.x this) (.x that)))))

(deftype ZZZUnComparable [x]
  Object
  (equals [this that]
    (and (instance? ZZZUnComparable that)
         (= (.x this) (.x that)))))

(deftest test-nested-sort
  (are [input sorted] (= sorted (nested-sort input))
    {} {}
    [] []
    nil nil
    #{} #{}

    ;; plain sequences do not get sorted
    [1 4 3] [1 4 3]
    (map identity [1 4 3]) '(1 4 3)
    '(1 4 3) '(1 4 3)
    ;; but their contents do
    [#{2 1 20000 3 4} {:c 1 :a 2 :b 3}]
    [#{1 2 3 4 20000} {:a 2 :b 3 :c 1}]

    '({"conj" conj, "inc" inc, "dec" dec} #{"f" "m" "3"})
    '({"conj" conj, "dec" dec, "inc" inc} #{"3" "f" "m"})

    ;;

    {:b 1 :a 2}
    {:a 2 :b 1}

    [{:b 2 :a {:c {:d 3} :b 2 :a 1 }}]
    [(om/ordered-map :a (om/ordered-map :a 1 :b 2 :c (om/ordered-map :d 3))
                     :b 2)]

    ;; handles keys of different types by sorting them in groups
    ;; by their Class name
    {"a" 2 "b" 2 :b 1}
    {:b 1 "a" 2 "b" 2}

    #{"z" :s  3 2 1 :a "a"}
    (os/ordered-set 1 2 3 :a :s "a" "z") ;; Integer, Keyword, String

    ;; structures of comparables and uncomparables put the comparables
    ;; at the front
    #{(UnComparable. 1) :a}
    (os/ordered-set :a (UnComparable. 1))

    ;; ... ditto for maps.  Also, note non-comparables still get sorted
    ;; by Class name
    {(ZZZUnComparable. :a) 1
     (UnComparable. :c) #{"b" :s 1}
     (UnComparable. :b) #{"a" :s 1}}
    (om/ordered-map (UnComparable. :c) (os/ordered-set 1 :s "b")
                    (UnComparable. :b) (os/ordered-set 1 :s "a")
                    (ZZZUnComparable. :a) 1))

  (testing "Sort preserves classses"
      (is (= clojure.lang.PersistentVector (class (nested-sort []))))
      (is (= clojure.lang.PersistentVector (class (nested-sort [4 3 2 1]))))
      (is (= clojure.lang.PersistentList$EmptyList (class (nested-sort '()))))
      (is (= clojure.lang.PersistentList (class (nested-sort '(4 3 2 1)))))))


(def single-FAIL "FAIL in (test-fail) (NO_SOURCE_FILE:6)
expected: (= 1 2)
  actual: (not (= 1 2))")

(def multiple-FAILs "

FAIL in (test-fail) (NO_SOURCE_FILE:6)
expected: (= 1 2)
  actual: (not (= 1 2))

FAIL in (test-fail-more) (NO_SOURCE_FILE:67)
expected: (= {:A 1} {:a 1, :b 2, :c 3, :d 4, :e 5})
  actual: (not (= {:A 1} {:a 1, :c 3, :b 2, :d 4, :e 5}))

FAIL in (testing-dependents-version-gets-incremented-ech-digest-update) (access_spec.clj:222)
expected: (not= (:dependents-version (fetch-digest \"14\" 3333)) 3)
  actual: (not (no= 3 3))

FAIL in (testing-dependents-version-gets-incremented-ech-digest-update) (access_spec.clj:222)
expected: (pos? 3)
  actual: (not (pos? 3))")

(def different-heights-FAIL "FAIL in (test-fail-high) (NO_SOURCE_FILE:67)
expected: (= {:A 1} {:a 1, :b 2, :c 3, :d 4, :e 5})
  actual: (not (= {:A 1} {:a 11111, :c 33333777776666622222921347128472847124871472340, :b 2, :d 4, :e 55555}))")

(deftest test-1
  (is (= [{:test-name "test-fail"
              :file-info "NO_SOURCE_FILE:6"
              :expected "1\n"
              :actual "2\n"}
             {:test-name "test-fail-more"
              :file-info "NO_SOURCE_FILE:67"
              :expected "{:A 1}\n"
              :actual "{:a 1, :b 2, :c 3, :d 4, :e 5}\n"}]
            (#'gd/ct-report-str->failure-maps multiple-FAILs))))

(deftest test-2
  (is (= [{:test-name "test-fail"
           :file-info "NO_SOURCE_FILE:6"
           :expected "1\n"
           :actual "2\n"}]
         (#'gd/ct-report-str->failure-maps single-FAIL))))

(deftest test-33
  (is (= [{:test-name "test-fail-high"
           :file-info "NO_SOURCE_FILE:67"
           :expected "{:A 1}\n\n \n \n \n "
           :actual "{:a 11111,\n :b 2,\n :c 33333777776666622222921347128472847124871472340N,\n :d 4,\n :e 55555}\n"}]
         (#'gd/ct-report-str->failure-maps different-heights-FAIL))))

(deftest no-evaluate-args
  (testing "gui diff does not evaluate its args"
    (is (= (macroexpand '(gui.diff/gui-diff (1 2 3)
                                            (4 5 6)))
           '(gui.diff/gui-diff-data (quote (1 2 3))
                                    (quote (4 5 6)))))
    (is (= '[(1 2 3) (4 5 6)]
           (with-redefs [gui.diff/gui-diff-data vector]
             (gd/gui-diff (1 2 3) (4 5 6)))))))

(def regression-string-2
  "
:starts-on \"1970-01-01 00:20:31\",
:percentage 50.0,
:offer true}


Testing furtive.serenity.migration-spec

FAIL in (test-migrate) (migration_spec.clj:859)
session data events
expected: (= session-data-event (migrate legacy-session-data-event))
  actual: (not (= {:timestamp 123450000, :data {:paid-ad true, :timezone \"EST\", :sushi true, :offer-model :random, :baseline-info {:enabled true, :starts-on 1231231, :percentage 50.0, :offer true}, :url-referrer \"http://www.twitter.com\", :bucket 123, :paid-search-terms [\":apple\" \":banana\" \":cherry\"], :session-start-time 12412444, :landing-url \"http://www.shoes.com\", :consumer {:site-cid \"e5b03c68-318f-4072-a626-e3f423a2b555\", :runa-cid \"e5b03c68-318f-4072-a626-e3f423a2b444\", :url-referrer \"http://www.twitter.com\", :ip-address \"64.9.247.255\"}, :rmc-cookies {:rmc-1 \"foo\"}, :search-terms (\":donut\" \":eggos\"), :merchant {:id \"e5b03c68-318f-4072-a626-e3f423a2b222\", :vertical \"high\", :platform \"some platform\"}, :geo-data {:ipinfo {:location {:state-data {:state-code \"RI\"}, :country-data {:country-code \"USA\"}}}}, :client-info {:runa-cid \"e5b03c68-318f-4072-a626-e3f423a2b444\", :ip-address \"64.9.247.255\", :browser {:name \"Chrome\", :rendering-engine \"re\"}, :os {:name \"Windows 7\"}, :device {:mobile? false, :type \"laptop\"}}}, :runa-enabled true, :merchant-id \"e5b03c68-318f-4072-a626-e3f423a2b222\", :event-id \"123450000:abcdefgh\", :event-type :session-data, :git-sha \"f43283cd56fb1e2dcf4c992aad79f050fe345ba5\", :session-id \"e5b03c68-318f-4072-a626-e3f423a2b333\", :version 1, :site-cid \"e5b03c68-318f-4072-a626-e3f423a2b555\", :runa-cid \"e5b03c68-318f-4072-a626-e3f423a2b555\"} {:timestamp 123450000, :data {:paid-ad true, :timezone \"EST\", :sushi true, :offer-model :random, :baseline-info {:enabled true, :starts-on 1231000, :percentage 50.0, :offer true}, :url-referrer \"http://www.twitter.com\", :bucket 123, :paid-search-terms (\":apple\" \":banana\" \":cherry\"), :session-start-time 12412444, :landing-url \"http://www.shoes.com\", :consumer {:site-cid \"e5b03c68-318f-4072-a626-e3f423a2b555\", :runa-cid \"e5b03c68-318f-4072-a626-e3f423a2b444\", :url-referrer \"http://www.twitter.com\", :ip-address \"64.9.247.255\"}, :rmc-cookies {:rmc-1 \"foo\"}, :search-terms (\":donut\" \":eggos\"), :merchant {:id \"e5b03c68-318f-4072-a626-e3f423a2b222\", :vertical \"high\", :platform \"some platform\"}, :geo-data {:ipinfo {:location {:state-data {:state-code \"RI\"}, :country-data {:country-code \"USA\"}}}}, :client-info {:runa-cid \"e5b03c68-318f-4072-a626-e3f423a2b444\", :ip-address \"64.9.247.255\", :browser {:name \"Chrome\", :rendering-engine \"re\"}, :os {:name \"Windows 7\"}, :device {:mobile? false, :type \"laptop\"}}}, :runa-enabled true, :merchant-id \"e5b03c68-318f-4072-a626-e3f423a2b222\", :event-id \"123450000:abcdefgh\", :event-type :session-data, :git-sha \"f43283cd56fb1e2dcf4c992aad79f050fe345ba5\", :session-id \"e5b03c68-318f-4072-a626-e3f423a2b333\", :version 1, :site-cid \"e5b03c68-318f-4072-a626-e3f423a2b555\", :runa-cid \"e5b03c68-318f-4072-a626-e3f423a2b555\"}))

FAIL in (test-migrate) (migration_spec.clj:859)
session data events
expected: (= session-data-event---missing-data (migrate legacy-session-data-event---missing-data))
  actual: (not (= {:timestamp 123450000, :data {:paid-ad true, :timezone \"EST\", :sushi nil, :offer-model :random, :baseline-info {:enabled true, :starts-on 1231231, :percentage 50.0, :offer true}, :url-referrer nil, :bucket 123, :paid-search-terms [], :session-start-time 12412444, :landing-url \"http://www.shoes.com\", :consumer {:site-cid \"e5b03c68-318f-4072-a626-e3f423a2b555\", :runa-cid nil, :url-referrer nil, :ip-address \"64.9.247.255\"}, :search-terms [], :merchant {:id \"e5b03c68-318f-4072-a626-e3f423a2b222\", :vertical \"high\", :platform \"some platform\"}, :geo-data {:ipinfo {:location {:state-data {:state-code \"RI\"}, :country-data {:country-code \"USA\"}}}, :extr-geo-data {:temperature {:amount 55, :unit \"F\"}}}, :client-info {:runa-cid \"e5b03c68-318f-4072-a626-e3f423a2b444\", :ip-address \"64.9.247.255\", :browser {:name \"Chrome\", :rendering-engine nil}, :device {:mobile? false, :type nil}}}, :runa-enabled true, :merchant-id \"e5b03c68-318f-4072-a626-e3f423a2b222\", :event-id \"123450000:abcdefgh\", :event-type :session-data, :git-sha \"f43283cd56fb1e2dcf4c992aad79f050fe345ba5\", :session-id \"e5b03c68-318f-4072-a626-e3f423a2b333\", :version 1, :site-cid \"e5b03c68-318f-4072-a626-e3f423a2b555\", :runa-cid nil} {:timestamp 123450000, :data {:paid-ad true, :timezone \"EST\", :sushi nil, :offer-model :random, :baseline-info {:enabled true, :starts-on 1231000, :percentage 50.0, :offer true}, :url-referrer nil, :bucket 123, :paid-search-terms (), :session-start-time 12412444, :landing-url \"http://www.shoes.com\", :consumer {:site-cid \"e5b03c68-318f-4072-a626-e3f423a2b555\", :runa-cid nil, :url-referrer nil, :ip-address \"64.9.247.255\"}, :search-terms (), :merchant {:id \"e5b03c68-318f-4072-a626-e3f423a2b222\", :vertical \"high\", :platform \"some platform\"}, :geo-data {:ipinfo {:location {:state-data {:state-code \"RI\"}, :country-data {:country-code \"USA\"}}}, :extr-geo-data {:temperature {:amount 55, :unit \"F\"}}}, :client-info {:runa-cid \"e5b03c68-318f-4072-a626-e3f423a2b444\", :ip-address \"64.9.247.255\", :browser {:name \"Chrome\", :rendering-engine nil}, :device {:mobile? false, :type nil}}}, :runa-enabled true, :merchant-id \"e5b03c68-318f-4072-a626-e3f423a2b222\", :event-id \"123450000:abcdefgh\", :event-type :session-data, :git-sha \"f43283cd56fb1e2dcf4c992aad79f050fe345ba5\", :session-id \"e5b03c68-318f-4072-a626-e3f423a2b333\", :version 1, :site-cid \"e5b03c68-318f-4072-a626-e3f423a2b555\", :runa-cid nil}))

FAIL in (regression--baseline-info-schemas-were-too-strict) (migration_spec.clj:951)
expected: (= migrated-oscaro-session-data-event (migrate legacy-oscaro-session-data-event))
  actual: (not (= {:timestamp 1343799567304, :data {:paid-ad false, :sushi nil, :baseline-info {:offer true, :starts-on 1343737980000, :enabled true, :percentage 15.4}, :url-referrer nil, :paid-search-terms [], :session-start-time 1343799567303, :landing-url nil, :consumer {:url-referrer nil, :ip-address \"50.131.104.242\", :runa-cid \"49062b00-ba24-4971-a453-2d511854e409\", :site-cid \"sid-41840352-db9b-11e1-b346-f3dcb85b63ab\"}, :rmc-cookies {:rmc-1 \"1\"}, :search-terms [], :merchant {:id \"74992639-fec6-3187-b23b-be27eea1c919\", :vertical \"retailer\", :platform \"other\"}, :geo-data nil, :client-info {:device {:mobile? false, :type \"Computer\"}, :os {:name \"Mac OS X\"}, :browser {:name \"Firefox\", :rendering-engine \"GECKO\"}, :ip-address \"50.131.104.242\", :runa-cid \"619eaf35-1dda-4869-8a93-b18877bbdee7\"}}, :runa-enabled false, :merchant-id \"74992639-fec6-3187-b23b-be27eea1c919\", :event-id \"1343799567304:4b194b81-a0d0-41d8-b25b-761a805b039f\", :event-type :session-data, :git-sha \"3dcb6dbae72a1598d9cd160d523504091fdb633b\", :session-id \"4b194b81-a0d0-41d8-b25b-761a805b039f\", :version 1, :site-cid \"sid-41840352-db9b-11e1-b346-f3dcb85b63ab\", :runa-cid nil} {:timestamp 1343799567304, :data {:paid-ad false, :sushi nil, :baseline-info {:offer true, :starts-on \"2012-07-31 12:33\", :enabled true, :percentage 15.4}, :url-referrer nil, :paid-search-terms [], :session-start-time 1343799567303, :landing-url nil, :consumer {:url-referrer nil, :ip-address \"50.131.104.242\", :runa-cid \"49062b00-ba24-4971-a453-2d511854e409\", :site-cid \"sid-41840352-db9b-11e1-b346-f3dcb85b63ab\"}, :rmc-cookies {:rmc-1 \"1\"}, :search-terms [], :merchant {:id \"74992639-fec6-3187-b23b-be27eea1c919\", :vertical \"retailer\", :platform \"other\"}, :geo-data nil, :client-info {:device {:mobile? false, :type \"Computer\"}, :os {:name \"Mac OS X\"}, :browser {:name \"Firefox\", :rendering-engine \"GECKO\"}, :ip-address \"50.131.104.242\", :runa-cid \"619eaf35-1dda-4869-8a93-b18877bbdee7\"}}, :runa-enabled false, :merchant-id \"74992639-fec6-3187-b23b-be27eea1c919\", :event-id \"1343799567304:4b194b81-a0d0-41d8-b25b-761a805b039f\", :event-type :session-data, :git-sha \"3dcb6dbae72a1598d9cd160d523504091fdb633b\", :session-id \"4b194b81-a0d0-41d8-b25b-761a805b039f\", :version 1, :site-cid \"sid-41840352-db9b-11e1-b346-f3dcb85b63ab\", :runa-cid nil}))

Ran 5 tests containing 36 assertions.
3 failures, 0 errors.")


(deftest test-regression
  (is (= 3
         (count (#'gd/ct-report-str->failure-maps regression-string-2)))))

(def regression-string-3
  "FAIL in (testing-dependents-version-gets-incremented-ech-digest-update) (access_spec.clj:214)
expected: (= (:dependents-version (fetch-digest \"14\" 1111)) 1)
  actual: (not (= 9 1))

FAIL in (testing-dependents-version-gets-incremented-ech-digest-update) (access_spec.clj:218)
expected: (= (:dependents-version (fetch-digest \"14\" 2222)) 2)
  actual: (not (= 10 2))

FAIL in (testing-dependents-version-gets-incremented-ech-digest-update) (access_spec.clj:222)
expected: (= (:dependents-version (fetch-digest \"14\" 3333)) 3)
  actual: (not (= 11 3))

FAIL in (test-digest-access) (access_spec.clj:198)
can save digest, access them as a seq, or fetch individually by timestamp
expected: (= (digest-seq \"14\") [enveloped-digest-a enveloped-digest-b])
  actual: (not (= ({:locked false, :dirty true, :dependents-version 9, :timestamp 0, :digest {:merchant-id \"14\", :control {:total-sessions 0, :viewed {:total-sessions 0, :total-cents 0}, :purchased {:total-cents 0, :runa-discount-total-cents 0, :products-total-cents 0, :tax-total-cents 0, :shipping-total-cents 0, :other-charges-total-cents 0, :total-sessions 0, :invoiced-cents-squared 0}, :carted {:total-cents 0, :runa-discount-total-cents 0, :products-total-cents 0, :tax-total-cents 0, :shipping-total-cents 0, :other-charges-total-cents 0, :total-sessions 0}}, :promos {:purchased {\"Bar\" 12}, :carted {\"Foo\" 3}}, :test {:total-sessions 1, :viewed {:total-sessions 1, :total-cents 200}, :purchased {:total-cents 1315, :runa-discount-total-cents -10, :products-total-cents 200, :tax-total-cents 125, :shipping-total-cents 1000, :other-charges-total-cents 0, :total-sessions 1, :invoiced-cents-squared 36100}, :carted {:total-cents 1315, :runa-discount-total-cents -10, :products-total-cents 200, :tax-total-cents 125, :shipping-total-cents 1000, :other-charges-total-cents 0, :total-sessions 1}}, :start 1500, :total-carted-sessions 1, :end 1500, :unmanaged {:total-sessions 0, :viewed {:total-sessions 0, :total-cents 0}, :purchased {:total-cents 0, :runa-discount-total-cents 0, :products-total-cents 0, :tax-total-cents 0, :shipping-total-cents 0, :other-charges-total-cents 0, :total-sessions 0, :invoiced-cents-squared 0}, :carted {:total-cents 0, :runa-discount-total-cents 0, :products-total-cents 0, :tax-total-cents 0, :shipping-total-cents 0, :other-charges-total-cents 0, :total-sessions 0}}, :total-viewed-sessions 1, :carted {:total-cents 1315, :runa-discount-total-cents -10, :products-total-cents 200, :tax-total-cents 125, :shipping-total-cents 1000, :other-charges-total-cents 0, :total-sessions 1}, :version 1, :purchased {:total-cents 1315, :runa-discount-total-cents -10, :products-total-cents 200, :tax-total-cents 125, :shipping-total-cents 1000, :other-charges-total-cents 0, :total-sessions 1, :invoiced-cents-squared 36100}, :total-sessions 1, :total-purchased-sessions 1, :viewed {:total-sessions 1, :total-cents 200}, :managed {:total-sessions 1, :viewed {:total-sessions 1, :total-cents 200}, :purchased {:total-cents 1315, :runa-discount-total-cents -10, :products-total-cents 200, :tax-total-cents 125, :shipping-total-cents 1000, :other-charges-total-cents 0, :total-sessions 1, :invoiced-cents-squared 36100}, :carted {:total-cents 1315, :runa-discount-total-cents -10, :products-total-cents 200, :tax-total-cents 125, :shipping-total-cents 1000, :other-charges-total-cents 0, :total-sessions 1}}, :excluded {:total-sessions 0, :viewed {:total-sessions 0, :total-cents 0}, :purchased {:total-cents 0, :runa-discount-total-cents 0, :products-total-cents 0, :tax-total-cents 0, :shipping-total-cents 0, :other-charges-total-cents 0, :total-sessions 0, :invoiced-cents-squared 0}, :carted {:total-cents 0, :runa-discount-total-cents 0, :products-total-cents 0, :tax-total-cents 0, :shipping-total-cents 0, :other-charges-total-cents 0, :total-sessions 0}}, :discounted {:total-sessions 1, :viewed {:total-sessions 1, :total-cents 200}, :purchased {:total-cents 1315, :runa-discount-total-cents -10, :products-total-cents 200, :tax-total-cents 125, :shipping-total-cents 1000, :other-charges-total-cents 0, :total-sessions 1, :invoiced-cents-squared 36100}, :carted {:total-cents 1315, :runa-discount-total-cents -10, :products-total-cents 200, :tax-total-cents 125, :shipping-total-cents 1000, :other-charges-total-cents 0, :total-sessions 1}}, :denied {:total-sessions 0, :viewed {:total-sessions 0, :total-cents 0}, :purchased {:total-cents 0, :runa-discount-total-cents 0, :products-total-cents 0, :tax-total-cents 0, :shipping-total-cents 0, :other-charges-total-cents 0, :total-sessions 0, :invoiced-cents-squared 0}, :carted {:total-cents 0, :runa-discount-total-cents 0, :products-total-cents 0, :tax-total-cents 0, :shipping-total-cents 0, :other-charges-total-cents 0, :total-sessions 0}}}} {:locked false, :dirty true, :dependents-version 1, :timestamp 997200000, :digest {:merchant-id \"14\", :control {:total-sessions 0, :viewed {:total-sessions 0, :total-cents 0}, :purchased {:total-cents 0, :runa-discount-total-cents 0, :products-total-cents 0, :tax-total-cents 0, :shipping-total-cents 0, :other-charges-total-cents 0, :total-sessions 0, :invoiced-cents-squared 0}, :carted {:total-cents 0, :runa-discount-total-cents 0, :products-total-cents 0, :tax-total-cents 0, :shipping-total-cents 0, :other-charges-total-cents 0, :total-sessions 0}}, :promos {:purchased {\"Bar\" 12}, :carted {\"Foo\" 3}}, :test {:total-sessions 1, :viewed {:total-sessions 1, :total-cents 200}, :purchased {:total-cents 1315, :runa-discount-total-cents -10, :products-total-cents 200, :tax-total-cents 125, :shipping-total-cents 1000, :other-charges-total-cents 0, :total-sessions 1, :invoiced-cents-squared 36100}, :carted {:total-cents 1315, :runa-discount-total-cents -10, :products-total-cents 200, :tax-total-cents 125, :shipping-total-cents 1000, :other-charges-total-cents 0, :total-sessions 1}}, :start 1500, :total-carted-sessions 1, :end 1500, :unmanaged {:total-sessions 0, :viewed {:total-sessions 0, :total-cents 0}, :purchased {:total-cents 0, :runa-discount-total-cents 0, :products-total-cents 0, :tax-total-cents 0, :shipping-total-cents 0, :other-charges-total-cents 0, :total-sessions 0, :invoiced-cents-squared 0}, :carted {:total-cents 0, :runa-discount-total-cents 0, :products-total-cents 0, :tax-total-cents 0, :shipping-total-cents 0, :other-charges-total-cents 0, :total-sessions 0}}, :total-viewed-sessions 1, :carted {:total-cents 1315, :runa-discount-total-cents -10, :products-total-cents 200, :tax-total-cents 125, :shipping-total-cents 1000, :other-charges-total-cents 0, :total-sessions 1}, :version 1, :purchased {:total-cents 1315, :runa-discount-total-cents -10, :products-total-cents 200, :tax-total-cents 125, :shipping-total-cents 1000, :other-charges-total-cents 0, :total-sessions 1, :invoiced-cents-squared 36100}, :total-sessions 1, :total-purchased-sessions 1, :viewed {:total-sessions 1, :total-cents 200}, :managed {:total-sessions 1, :viewed {:total-sessions 1, :total-cents 200}, :purchased {:total-cents 1315, :runa-discount-total-cents -10, :products-total-cents 200, :tax-total-cents 125, :shipping-total-cents 1000, :other-charges-total-cents 0, :total-sessions 1, :invoiced-cents-squared 36100}, :carted {:total-cents 1315, :runa-discount-total-cents -10, :products-total-cents 200, :tax-total-cents 125, :shipping-total-cents 1000, :other-charges-total-cents 0, :total-sessions 1}}, :excluded {:total-sessions 0, :viewed {:total-sessions 0, :total-cents 0}, :purchased {:total-cents 0, :runa-discount-total-cents 0, :products-total-cents 0, :tax-total-cents 0, :shipping-total-cents 0, :other-charges-total-cents 0, :total-sessions 0, :invoiced-cents-squared 0}, :carted {:total-cents 0, :runa-discount-total-cents 0, :products-total-cents 0, :tax-total-cents 0, :shipping-total-cents 0, :other-charges-total-cents 0, :total-sessions 0}}, :discounted {:total-sessions 1, :viewed {:total-sessions 1, :total-cents 200}, :purchased {:total-cents 1315, :runa-discount-total-cents -10, :products-total-cents 200, :tax-total-cents 125, :shipping-total-cents 1000, :other-charges-total-cents 0, :total-sessions 1, :invoiced-cents-squared 36100}, :carted {:total-cents 1315, :runa-discount-total-cents -10, :products-total-cents 200, :tax-total-cents 125, :shipping-total-cents 1000, :other-charges-total-cents 0, :total-sessions 1}}, :denied {:total-sessions 0, :viewed {:total-sessions 0, :total-cents 0}, :purchased {:total-cents 0, :runa-discount-total-cents 0, :products-total-cents 0, :tax-total-cents 0, :shipping-total-cents 0, :other-charges-total-cents 0, :total-sessions 0, :invoiced-cents-squared 0}, :carted {:total-cents 0, :runa-discount-total-cents 0, :products-total-cents 0, :tax-total-cents 0, :shipping-total-cents 0, :other-charges-total-cents 0, :total-sessions 0}}}}) [{:digest {:merchant-id \"14\", :control {:carted {:total-sessions 0, :other-charges-total-cents 0, :shipping-total-cents 0, :tax-total-cents 0, :products-total-cents 0, :runa-discount-total-cents 0, :total-cents 0}, :purchased {:invoiced-cents-squared 0, :total-sessions 0, :other-charges-total-cents 0, :shipping-total-cents 0, :tax-total-cents 0, :products-total-cents 0, :runa-discount-total-cents 0, :total-cents 0}, :viewed {:total-cents 0, :total-sessions 0}, :total-sessions 0}, :promos {:carted {\"Foo\" 3}, :purchased {\"Bar\" 12}}, :test {:carted {:total-sessions 1, :other-charges-total-cents 0, :shipping-total-cents 1000, :tax-total-cents 125, :products-total-cents 200, :runa-discount-total-cents -10, :total-cents 1315}, :purchased {:invoiced-cents-squared 36100, :total-sessions 1, :other-charges-total-cents 0, :shipping-total-cents 1000, :tax-total-cents 125, :products-total-cents 200, :runa-discount-total-cents -10, :total-cents 1315}, :viewed {:total-cents 200, :total-sessions 1}, :total-sessions 1}, :start 1500, :total-carted-sessions 1, :end 1500, :unmanaged {:carted {:total-sessions 0, :other-charges-total-cents 0, :shipping-total-cents 0, :tax-total-cents 0, :products-total-cents 0, :runa-discount-total-cents 0, :total-cents 0}, :purchased {:invoiced-cents-squared 0, :total-sessions 0, :other-charges-total-cents 0, :shipping-total-cents 0, :tax-total-cents 0, :products-total-cents 0, :runa-discount-total-cents 0, :total-cents 0}, :viewed {:total-cents 0, :total-sessions 0}, :total-sessions 0}, :total-viewed-sessions 1, :carted {:total-sessions 1, :other-charges-total-cents 0, :shipping-total-cents 1000, :tax-total-cents 125, :products-total-cents 200, :runa-discount-total-cents -10, :total-cents 1315}, :version 1, :purchased {:invoiced-cents-squared 36100, :total-sessions 1, :other-charges-total-cents 0, :shipping-total-cents 1000, :tax-total-cents 125, :products-total-cents 200, :runa-discount-total-cents -10, :total-cents 1315}, :total-sessions 1, :total-purchased-sessions 1, :viewed {:total-cents 200, :total-sessions 1}, :managed {:carted {:total-sessions 1, :other-charges-total-cents 0, :shipping-total-cents 1000, :tax-total-cents 125, :products-total-cents 200, :runa-discount-total-cents -10, :total-cents 1315}, :purchased {:invoiced-cents-squared 36100, :total-sessions 1, :other-charges-total-cents 0, :shipping-total-cents 1000, :tax-total-cents 125, :products-total-cents 200, :runa-discount-total-cents -10, :total-cents 1315}, :viewed {:total-cents 200, :total-sessions 1}, :total-sessions 1}, :excluded {:carted {:total-sessions 0, :other-charges-total-cents 0, :shipping-total-cents 0, :tax-total-cents 0, :products-total-cents 0, :runa-discount-total-cents 0, :total-cents 0}, :purchased {:invoiced-cents-squared 0, :total-sessions 0, :other-charges-total-cents 0, :shipping-total-cents 0, :tax-total-cents 0, :products-total-cents 0, :runa-discount-total-cents 0, :total-cents 0}, :viewed {:total-cents 0, :total-sessions 0}, :total-sessions 0}, :discounted {:carted {:total-sessions 1, :other-charges-total-cents 0, :shipping-total-cents 1000, :tax-total-cents 125, :products-total-cents 200, :runa-discount-total-cents -10, :total-cents 1315}, :purchased {:invoiced-cents-squared 36100, :total-sessions 1, :other-charges-total-cents 0, :shipping-total-cents 1000, :tax-total-cents 125, :products-total-cents 200, :runa-discount-total-cents -10, :total-cents 1315}, :viewed {:total-cents 200, :total-sessions 1}, :total-sessions 1}, :denied {:carted {:total-sessions 0, :other-charges-total-cents 0, :shipping-total-cents 0, :tax-total-cents 0, :products-total-cents 0, :runa-discount-total-cents 0, :total-cents 0}, :purchased {:invoiced-cents-squared 0, :total-sessions 0, :other-charges-total-cents 0, :shipping-total-cents 0, :tax-total-cents 0, :products-total-cents 0, :runa-discount-total-cents 0, :total-cents 0}, :viewed {:total-cents 0, :total-sessions 0}, :total-sessions 0}}, :timestamp 0, :dirty true, :locked false, :dependents-version 1} {:digest {:merchant-id \"14\", :control {:carted {:total-sessions 0, :other-charges-total-cents 0, :shipping-total-cents 0, :tax-total-cents 0, :products-total-cents 0, :runa-discount-total-cents 0, :total-cents 0}, :purchased {:invoiced-cents-squared 0, :total-sessions 0, :other-charges-total-cents 0, :shipping-total-cents 0, :tax-total-cents 0, :products-total-cents 0, :runa-discount-total-cents 0, :total-cents 0}, :viewed {:total-cents 0, :total-sessions 0}, :total-sessions 0}, :promos {:carted {\"Foo\" 3}, :purchased {\"Bar\" 12}}, :test {:carted {:total-sessions 1, :other-charges-total-cents 0, :shipping-total-cents 1000, :tax-total-cents 125, :products-total-cents 200, :runa-discount-total-cents -10, :total-cents 1315}, :purchased {:invoiced-cents-squared 36100, :total-sessions 1, :other-charges-total-cents 0, :shipping-total-cents 1000, :tax-total-cents 125, :products-total-cents 200, :runa-discount-total-cents -10, :total-cents 1315}, :viewed {:total-cents 200, :total-sessions 1}, :total-sessions 1}, :start 1500, :total-carted-sessions 1, :end 1500, :unmanaged {:carted {:total-sessions 0, :other-charges-total-cents 0, :shipping-total-cents 0, :tax-total-cents 0, :products-total-cents 0, :runa-discount-total-cents 0, :total-cents 0}, :purchased {:invoiced-cents-squared 0, :total-sessions 0, :other-charges-total-cents 0, :shipping-total-cents 0, :tax-total-cents 0, :products-total-cents 0, :runa-discount-total-cents 0, :total-cents 0}, :viewed {:total-cents 0, :total-sessions 0}, :total-sessions 0}, :total-viewed-sessions 1, :carted {:total-sessions 1, :other-charges-total-cents 0, :shipping-total-cents 1000, :tax-total-cents 125, :products-total-cents 200, :runa-discount-total-cents -10, :total-cents 1315}, :version 1, :purchased {:invoiced-cents-squared 36100, :total-sessions 1, :other-charges-total-cents 0, :shipping-total-cents 1000, :tax-total-cents 125, :products-total-cents 200, :runa-discount-total-cents -10, :total-cents 1315}, :total-sessions 1, :total-purchased-sessions 1, :viewed {:total-cents 200, :total-sessions 1}, :managed {:carted {:total-sessions 1, :other-charges-total-cents 0, :shipping-total-cents 1000, :tax-total-cents 125, :products-total-cents 200, :runa-discount-total-cents -10, :total-cents 1315}, :purchased {:invoiced-cents-squared 36100, :total-sessions 1, :other-charges-total-cents 0, :shipping-total-cents 1000, :tax-total-cents 125, :products-total-cents 200, :runa-discount-total-cents -10, :total-cents 1315}, :viewed {:total-cents 200, :total-sessions 1}, :total-sessions 1}, :excluded {:carted {:total-sessions 0, :other-charges-total-cents 0, :shipping-total-cents 0, :tax-total-cents 0, :products-total-cents 0, :runa-discount-total-cents 0, :total-cents 0}, :purchased {:invoiced-cents-squared 0, :total-sessions 0, :other-charges-total-cents 0, :shipping-total-cents 0, :tax-total-cents 0, :products-total-cents 0, :runa-discount-total-cents 0, :total-cents 0}, :viewed {:total-cents 0, :total-sessions 0}, :total-sessions 0}, :discounted {:carted {:total-sessions 1, :other-charges-total-cents 0, :shipping-total-cents 1000, :tax-total-cents 125, :products-total-cents 200, :runa-discount-total-cents -10, :total-cents 1315}, :purchased {:invoiced-cents-squared 36100, :total-sessions 1, :other-chargException in thread \"main\" es-total-cents 0, :shipping-total-cents 1000, :tax-total-cents 125, :products-total-cents 200, :runa-discount-total-cents -10, :total-cents 1315}, :viewed {:total-cents 200, :total-sessions 1}, :total-sessions 1}, :denied {:carted {:total-sessions 0, :other-charges-total-cents 0, :shipping-total-cents 0, :tax-total-cents 0, :products-total-cents 0, :runa-discount-total-cents 0, :total-cents 0}, :purchased {:invoiced-cents-squared 0, :total-sessions 0, :other-charges-total-cents 0, :shipping-total-cents 0, :tax-total-cents 0, :products-total-cents 0, :runa-discount-total-cents 0, :total-cents 0}, :viewed {:total-cents 0, :total-sessions 0}, :total-sessions 0}}, :timestamp 997200000, :dirty true, :locked false, :dependents-version 1}]))

FAIL in (test-digest-access) (access_spec.clj:199)
can save digest, access them as a seq, or fetch individually by timestamp
expected: (= (filter :dirty (digest-seq \"14\")) [enveloped-digest-a enveloped-digest-b])
java.lang.NullPointerException (spec_unit_suite.clj:0)  actual: (not (= ({:locked false, :dirty true, :dependents-version 9, :timestamp 0, :digest {:merchant-id \"14\", :control {:total-sessions 0, :viewed {:total-sessions 0, :total-cents 0}, :purchased {:total-cents 0, :runa-discount-total-cents 0, :products-total-cents 0, :tax-total-cents 0, :shipping-total-cents 0, :other-charges-total-cents 0, :total-sessions 0, :invoiced-cents-squared 0}, :carted {:total-cents 0, :runa-discount-total-cents 0, :products-total-cents 0, :tax-total-cents 0, :shipping-total-cents 0, :other-charges-total-cents 0, :total-sessions 0}}, :promos {:purchased {\"Bar\" 12}, :carted {\"Foo\" 3}}, :test {:total-sessions 1, :viewed {:total-sessions 1, :total-cents 200}, :purchased {:total-cents 1315, :runa-discount-total-cents -10, :products-total-cents 200, :tax-total-cents 125, :shipping-total-cents 1000, :other-charges-total-cents 0, :total-sessions 1, :invoiced-cents-squared 36100}, :carted {:total-cents 1315, :runa-discount-total-cents -10, :products-total-cents 200, :tax-total-cents 125, :shipping-total-cents 1000, :other-charges-total-cents 0, :total-sessions 1}}, :start 1500, :total-carted-sessions 1, :end 1500, :unmanaged {:total-sessions 0, :viewed {:total-sessions 0, :total-cents 0}, :purchased {:total-cents 0, :runa-discount-total-cents 0, :products-total-cents 0, :tax-total-cents 0, :shipping-total-cents 0, :other-charges-total-cents 0, :total-sessions 0, :invoiced-cents-squared 0}, :carted {:total-cents 0, :runa-discount-total-cents 0, :products-total-cents 0, :tax-total-cents 0, :shipping-total-cents 0, :other-charges-total-cents 0, :total-sessions 0}}, :total-viewed-sessions 1, :carted {:total-cents 1315, :runa-discount-total-cents -10, :products-total-cents 200, :tax-total-cents 125, :shipping-total-cents 1000, :other-charges-total-cents 0, :total-sessions 1}, :version 1, :purchased {:total-cents 1315, :runa-discount-total-cents -10, :products-total-cents 200, :tax-total-cents 125, :shipping-total-cents 1000, :other-charges-total-cents 0, :total-sessions 1, :invoiced-cents-squared 36100}, :total-sessions 1, :total-purchased-sessions 1, :viewed {:total-sessions 1, :total-cents 200}, :managed {:total-sessions 1, :viewed {:total-sessions 1, :total-cents 200}, :purchased {:total-cents 1315, :runa-discount-total-cents -10, :products-total-cents 200, :tax-total-cents 125, :shipping-total-cents 1000, :other-charges-total-cents 0, :total-sessions 1, :invoiced-cents-squared 36100}, :carted {:total-cents 1315, :runa-discount-total-cents -10, :products-total-cents 200, :tax-total-cents 125, :shipping-total-cents 1000, :other-charges-total-cents 0, :total-sessions 1}}, :excluded {:total-sessions 0, :viewed {:total-sessions 0, :total-cents 0}, :purchased {:total-cents 0, :runa-discount-total-cents 0, :products-total-cents 0, :tax-total-cents 0, :shipping-total-cents 0, :other-charges-total-cents 0, :total-sessions 0, :invoiced-cents-squared 0}, :carted {:total-cents 0, :runa-discount-total-cents 0, :products-total-cents 0, :tax-total-cents 0, :shipping-total-cents 0, :other-charges-total-cents 0, :total-sessions 0}}, :discounted {:total-sessions 1, :viewed {:total-sessions 1, :total-cents 200}, :purchased {:total-cents 1315, :runa-discount-total-cents -10, :products-total-cents 200, :tax-total-cents 125, :shipping-total-cents 1000, :other-charges-total-cents 0, :total-sessions 1, :invoiced-cents-squared 36100}, :carted {:total-cents 1315, :runa-discount-total-cents -10, :products-total-cents 200, :tax-total-cents 125, :shipping-total-cents 1000, :other-charges-total-cents 0, :total-sessions 1}}, :denied {:total-sessions 0, :viewed {:total-sessions 0, :total-cents 0}, :purchased {:total-cents 0, :runa-discount-total-cents 0, :products-total-cents 0, :tax-total-cents 0, :shipping-total-cents 0, :other-charges-total-cents 0, :total-sessions 0, :invoiced-cents-squared 0}, :carted {:total-cents 0, :runa-discount-total-cents 0, :products-total-cents 0, :tax-total-cents 0, :shipping-total-cents 0, :other-charges-total-cents 0, :total-sessions 0}}}} {:locked false, :dirty true, :dependents-version 1, :timestamp 997200000, :digest {:merchant-id \"14\", :control {:total-sessions 0, :viewed {:total-sessions 0, :total-cents 0}, :purchased {:total-cents 0, :runa-discount-total-cents 0, :products-total-cents 0, :tax-total-cents 0, :shipping-total-cents 0, :other-charges-total-cents 0, :total-sessions 0, :invoiced-cents-squared 0}, :carted {:total-cents 0, :runa-discount-total-cents 0, :products-total-cents 0, :tax-total-cents 0, :shipping-total-cents 0, :other-charges-total-cents 0, :total-sessions 0}}, :promos {:purchased {\"Bar\" 12}, :carted {\"Foo\" 3}}, :test {:total-sessions 1, :viewed {:total-sessions 1, :total-cents 200}, :purchased {:total-cents 1315, :runa-discount-total-cents -10, :products-total-cents 200, :tax-total-cents 125, :shipping-total-cents 1000, :other-charges-total-cents 0, :total-sessions 1, :invoiced-cents-squared 36100}, :carted {:total-cents 1315, :runa-discount-total-cents -10, :products-total-cents 200, :tax-total-cents 125, :shipping-total-cents 1000, :other-charges-total-cents 0, :total-sessions 1}}, :start 1500, :total-carted-sessions 1, :end 1500, :unmanaged {:total-sessions 0, :viewed {:total-sessions 0, :total-cents 0}, :purchased {:total-cents 0, :runa-discount-total-cents 0, :products-total-cents 0, :tax-total-cents 0, :shipping-total-cents 0, :other-charges-total-cents 0, :total-sessions 0, :invoiced-cents-squared 0}, :carted {:total-cents 0, :runa-discount-total-cents 0, :products-total-cents 0, :tax-total-cents 0, :shipping-total-cents 0, :other-charges-total-cents 0, :total-sessions 0}}, :total-viewed-sessions 1, :carted {:total-cents 1315, :runa-discount-total-cents -10, :products-total-cents 200, :tax-total-cents 125, :shipping-total-cents 1000, :other-charges-total-cents 0, :total-sessions 1}, :version 1, :purchased {:total-cents 1315, :runa-discount-total-cents -10, :products-total-cents 200, :tax-total-cents 125, :shipping-total-cents 1000, :other-charges-total-cents 0, :total-sessions 1, :invoiced-cents-squared 36100}, :total-sessions 1, :total-purchased-sessions 1, :viewed {:total-sessions 1, :total-cents 200}, :managed {:total-sessions 1, :viewed {:total-sessions 1, :total-cents 200}, :purchased {:total-cents 1315, :runa-discount-total-cents -10, :products-total-cents 200, :tax-total-cents 125, :shipping-total-cents 1000, :other-charges-total-cents 0, :total-sessions 1, :invoiced-cents-squared 36100}, :carted {:total-cents 1315, :runa-discount-total-cents -10, :products-total-cents 200, :tax-total-cents 125, :shipping-total-cents 1000, :other-charges-total-cents 0, :total-sessions 1}}, :excluded {:total-sessions 0, :viewed {:total-sessions 0, :total-cents 0}, :purchased {:total-cents 0, :runa-discount-total-cents 0, :products-total-cents 0, :tax-total-cents 0, :shipping-total-cents 0, :other-charges-total-cents 0, :total-sessions 0, :invoiced-cents-squared 0}, :carted {:total-cents 0, :runa-discount-total-cents 0, :products-total-cents 0, :tax-total-cents 0, :shipping-total-cents 0, :other-charges-total-cents 0, :total-sessions 0}}, :discounted {:total-sessions 1, :viewed {:total-sessions 1, :total-cents 200}, :purchased {:total-cents 1315, :runa-discount-total-cents -10, :products-total-cents 200, :tax-total-cents 125, :shipping-total-cents 1000, :other-charges-total-cents 0, :total-sessions 1, :invoiced-cents-squared 36100}, :carted {:total-cents 1315, :runa-discount-total-cents -10, :products-total-cents 200, :tax-total-cents 125, :shipping-total-cents 1000, :other-charges-total-cents 0, :total-sessions 1}}, :denied {:total-sessions 0, :viewed {:total-sessions 0, :total-cents 0}, :purchased {:total-cents 0, :runa-discount-total-cents 0, :products-total-cents 0, :tax-total-cents 0, :shipping-total-cents 0, :other-charges-total-cents 0, :total-sessions 0, :invoiced-cents-squared 0}, :carted {:total-cents 0, :runa-discount-total-cents 0, :products-total-cents 0, :tax-total-cents 0, :shipping-total-cents 0, :other-charges-total-cents 0, :total-sessions 0}}}}) [{:digest {:merchant-id \"14\", :control {:carted {:total-sessions 0, :other-charges-total-cents 0, :shipping-total-cents 0, :tax-total-cents 0, :products-total-cents 0, :runa-discount-total-cents 0, :total-cents 0}, :purchased {:invoiced-cents-squared 0, :total-sessions 0, :other-charges-total-cents 0, :shipping-total-cents 0, :tax-total-cents 0, :products-total-cents 0, :runa-discount-total-cents 0, :total-cents 0}, :viewed {:total-cents 0, :total-sessions 0}, :total-sessions 0}, :promos {:carted {\"Foo\" 3}, :purchased {\"Bar\" 12}}, :test {:carted {:total-sessions 1, :other-charges-total-cents 0, :shipping-total-cents 1000, :tax-total-cents 125, :products-total-cents 200, :runa-discount-total-cents -10, :total-cents 1315}, :purchased {:invoiced-cents-squared 36100, :total-sessions 1, :other-charges-total-cents 0, :shipping-total-cents 1000, :tax-total-cents 125, :products-total-cents 200, :runa-discount-total-cents -10, :total-cents 1315}, :viewed {:total-cents 200, :total-sessions 1}, :total-sessions 1}, :start 1500, :total-carted-sessions 1, :end 1500, :unmanaged {:carted {:total-sessions 0, :other-charges-total-cents 0, :shipping-total-cents 0, :tax-total-cents 0, :products-total-cents 0, :runa-discount-total-cents 0, :total-cents 0}, :purchased {:invoiced-cents-squared 0, :total-sessions 0, :other-charges-total-cents 0, :shipping-total-cents 0, :tax-total-cents 0, :products-total-cents 0, :runa-discount-total-cents 0, :total-cents 0}, :viewed {:total-cents 0, :total-sessions 0}, :total-sessions 0}, :total-viewed-sessions 1, :carted {:total-sessions 1, :other-charges-total-cents 0, :shipping-total-cents 1000, :tax-total-cents 125, :products-total-cents 200, :runa-discount-total-cents -10, :total-cents 1315}, :version 1, :purchased {:invoiced-cents-squared 36100, :total-sessions 1, :other-charges-total-cents 0, :shipping-total-cents 1000, :tax-total-cents 125, :products-total-cents 200, :runa-discount-total-cents -10, :total-cents 1315}, :total-sessions 1, :total-purchased-sessions 1, :viewed {:total-cents 200, :total-sessions 1}, :managed {:carted {:total-sessions 1, :other-charges-total-cents 0, :shipping-total-cents 1000, :tax-total-cents 125, :products-total-cents 200, :runa-discount-total-cents -10, :total-cents 1315}, :purchased {:invoiced-cents-squared 36100, :total-sessions 1, :other-charges-total-cents 0, :shipping-total-cents 1000, :tax-total-cents 125, :products-total-cents 200, :runa-discount-total-cents -10, :total-cents 1315}, :viewed {:total-cents 200, :total-sessions 1}, :total-sessions 1}, :excluded {:carted {:total-sessions 0, :other-charges-total-cents 0, :shipping-total-cents 0, :tax-total-cents 0, :products-total-cents 0, :runa-discount-total-cents 0, :total-cents 0}, :purchased {:invoiced-cents-squared 0, :total-sessions 0, :other-charges-total-cents 0, :shipping-total-cents 0, :tax-total-cents 0, :products-total-cents 0, :runa-discount-total-cents 0, :total-cents 0}, :viewed {:total-cents 0, :total-sessions 0}, :total-sessions 0}, :discounted {:carted {:total-sessions 1, :other-charges-total-cents 0, :shipping-total-cents 1000, :tax-total-cents 125, :products-total-cents 200, :runa-discount-total-cents -10, :total-cents 1315}, :purchased {:invoiced-cents-squared 36100, :total-sessions 1, :other-charges-total-cents 0, :shipping-total-cents 1000, :tax-total-cents 125, :products-total-cents 200, :runa-discount-total-cents -10, :total-cents 1315}, :viewed {:total-cents 200, :total-sessions 1}, :total-sessions 1}, :denied {:carted {:total-sessions 0, :other-charges-total-cents 0, :shipping-total-cents 0, :tax-total-cents 0, :products-total-cents 0, :runa-discount-total-cents 0, :total-cents 0}, :purchased {:invoiced-cents-squared 0, :total-sessions 0, :other-charges-total-cents 0, :shipping-total-cents 0, :tax-total-cents 0, :products-total-cents 0, :runa-discount-total-cents 0, :total-cents 0}, :viewed {:total-cents 0, :total-sessions 0}, :total-sessions 0}}, :timestamp 0, :dirty true, :locked false, :dependents-version 1} {:digest {:merchant-id \"14\", :control {:carted {:total-sessions 0, :other-charges-total-cents 0, :shipping-total-cents 0, :tax-total-cents 0, :products-total-cents 0, :runa-discount-total-cents 0, :total-cents 0}, :purchased {:invoiced-cents-squared 0, :total-sessions 0, :other-charges-total-cents 0, :shipping-total-cents 0, :tax-total-cents 0, :products-total-cents 0, :runa-discount-total-cents 0, :total-cents 0}, :viewed {:total-cents 0, :total-sessions 0}, :total-sessions 0}, :promos {:carted {\"Foo\" 3}, :purchased {\"Bar\" 12}}, :test {:carted {:total-sessions 1, :other-charges-total-cents 0, :shipping-total-cents 1000, :tax-total-cents 125, :products-total-cents 200, :runa-discount-total-cents -10, :total-cents 1315}, :purchased {:invoiced-cents-squared 36100, :total-sessions 1, :other-charges-total-cents 0, :shipping-total-cents 1000, :tax-total-cents 125, :products-total-cents 200, :runa-discount-total-cents -10, :total-cents 1315}, :viewed {:total-cents 200, :total-sessions 1}, :total-sessions 1}, :start 1500, :total-carted-sessions 1, :end 1500, :unmanaged {:carted {:total-sessions 0, :other-charges-total-cents 0, :shipping-total-cents 0, :tax-total-cents 0, :products-total-cents 0, :runa-discount-total-cents 0, :total-cents 0}, :purchased {:invoiced-cents-squared 0, :total-sessions 0, :other-charges-total-cents 0, :shipping-total-cents 0, :tax-total-cents 0, :products-total-cents 0, :runa-discount-total-cents 0, :total-cents 0}, :viewed {:total-cents 0, :total-sessions 0}, :total-sessions 0}, :total-viewed-sessions 1, :carted {:total-sessions 1, :other-charges-total-cents 0, :shipping-total-cents 1000, :tax-total-cents 125, :products-total-cents 200, :runa-discount-total-cents -10, :total-cents 1315}, :version 1, :purchased {:invoiced-cents-squared 36100, :total-sessions 1, :other-charges-total-cents 0, :shipping-total-cents 1000, :tax-total-cents 125, :products-total-cents 200, :runa-discount-total-cents -10, :total-cents 1315}, :total-sessions 1, :total-purchased-sessions 1, :viewed {:total-cents 200, :total-sessions 1}, :managed {:carted {:total-sessions 1, :other-charges-total-cents 0, :shipping-total-cents 1000, :tax-total-cents 125, :products-total-cents 200, :runa-discount-total-cents -10, :total-cents 1315}, :purchased {:invoiced-cents-squared 36100, :total-sessions 1, :other-charges-total-cents 0, :shipping-total-cents 1000, :tax-total-cents 125, :products-total-cents 200, :runa-discount-total-cents -10, :total-cents 1315}, :viewed {:total-cents 200, :total-sessions 1}, :total-sessions 1}, :excluded {:carted {:total-sessions 0, :other-charges-total-cents 0, :shipping-total-cents 0, :tax-total-cents 0, :products-total-cents 0, :runa-discount-total-cents 0, :total-cents 0}, :purchased {:invoiced-cents-squared 0, :total-sessions 0, :other-charges-total-cents 0, :shipping-total-cents 0, :tax-total-cents 0, :products-total-cents 0, :runa-discount-total-cents 0, :total-cents 0}, :viewed {:total-cents 0, :total-sessions 0}, :total-sessions 0}, :discounted {:carted {:total-sessions 1, :other-charges-total-cents 0, :shipping-total-cents 1000, :tax-total-cents 125, :products-total-cents 200, :runa-discount-total-cents -10, :total-cents 1315}, :purchased {:invoiced-cents-squared 36100, :total-sessions 1, :other-charges-total-cents 0, :shipping-total-cents 1000, :tax-total-cents 125, :products-total-cents 200, :runa-discount-total-cents -10, :total-cents 1315}, :viewed {:total-cents 200, :total-sessions 1}, :total-sessions 1}, :denied {:carted {:total-sessions 0, :other-charges-total-cents 0, :shipping-total-cents 0, :tax-total-cents 0, :products-total-cents 0, :runa-discount-total-cents 0, :total-cents 0}, :purchased {:invoiced-cents-squared 0, :total-sessions 0, :other-charges-total-cents 0, :shipping-total-cents 0, :tax-total-cents 0, :products-total-cents 0, :runa-discount-total-cents 0, :total-cents 0}, :viewed {:total-cents 0, :total-sessions 0}, :total-sessions 0}}, :timestamp 997200000, :dirty true, :locked false, :dependents-version 1}]))")

(deftest test-regression-3
  (is (= 5
         (count (#'gd/ct-report-str->failure-maps regression-string-3)))))

;; TODO: test exps/acts/ with differenet lengths/heights space properly in the
;; diff report
